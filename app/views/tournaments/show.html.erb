<h1><%= @tournament.name %></h1>

<hr>

<div class="row">
  <div class="span5">
    <h2>Details</h2>
    <table class="table">
      <thead>
      </thead>
      <tbody>
        <tr>
          <td><b>Name</b></td>
          <td><%= @tournament.name %></td>
        </tr>
        <tr>
          <td><b>Date started</b></td>
          <td><%= @tournament.date_started %></td>
        </tr>
        <tr>
          <td><b>Date finished</b></td>
          <td><%= @tournament.date_finished %></td>
        </tr>
        <tr>
          <td><b>Status</b></td>
          <td><%= @tournament.status %></td>
        </tr>
        <tr>
          <td><b>Admin</b></td>
          <td><%= @tournament.admin.name %></td>
        </tr>
      </tbody>
    </table>
  </div>

  <div class="span7">
    <h2>Players</h2>
    <table class="table">
    <% if @tournament.latest_standings %>
      <tr>
        <th>Pos.</th>
        <th>Name</th>
        <th>Points</th>
        <th>Rating</th>
      </tr>

      <% @tournament.latest_standings.each do |s| %>
      <tr>
        <td><%= s.position %></td>
        <td><%= s.player.name %></td>
        <td><%= s.points %></td>
        <td><%= s.player.ratings.last.value %></td>
      </tr>
      <% end %>
    <% else %>
      <% if @tournament.players.empty? %>
      <hr>
      <p class="alert alert-block alert-info">
        There are no players signed up for this tournament yet.
      </p>
      <% else %>
      <tr>
        <th>Name</th>
        <th>e-mail</th>
        <th>Rating</th>
      </tr>
        <% @tournament.players.each do |p| %>
      <tr>
        <td><%= p.name %></td>
        <td><%= p.email %></td>
        <td><%= p.ratings.last.value %></td>
      </tr>
        <% end %>
      <% end %>
    <% end %>
    </table>

  </div>
</div>

<div class="row">
  <div class="span7 offset5">
    <% if @tournament.players.include?(current_player) %>
    <!-- this is one of the ugliest things I've ever seen, seconded perhaps only by your momma.. -->

      <%= link_to participation_path(TournamentPlayer.find(current_player.tournament_players(:tournament_id => @tournament.id).first.id)),
        confirm: 'Are you sure?', method: :delete, :class => "btn btn-warning" do %>
        <i class="icon-white icon-remove-sign"></i>
        Withdraw from this tournament
      <% end %>

    <% else %>

      <%= form_for TournamentPlayer.new, :url => participations_path do |f| %>
        <%= f.hidden_field :tournament_id, :value => @tournament.id %>
        <%= f.hidden_field :player_id, :value => current_player.id %>
        <button type="submit" class="btn btn-success">
          <i class="icon-white icon-ok-sign"></i>
          Sign up for this tournament
        </button>
      <% end %>

    <% end %>
  </div>
</div>

<hr>

<div class="row">
  <div class="span12">
  <h2>Rounds</h2>
  <% if @tournament.rounds %>
  <div class="accordion" id="rounds-accordion">
    <% @tournament.rounds.each do |round| %>
    <div class="accordion-group">
      <div class="accordion-heading">
        <a class="accordion-toggle" data-toggle="collapse" data-parent="#rounds-accordion" href="#collapse<%= round.tournament_round_id %>">Round #<%= round.tournament_round_id %></a>
      </div>
      <div id="collapse<%= round.tournament_round_id %>" class="accordion-body collapse <%= 'in' if round.tournament_round_id == 1 %>">
        <div class="accordion-inner">
          <table class="table table-striped">
            <thead>
              <tr>
                <th><span class="pull-right">White</span></th>
                <th></th>
                <th></th>
                <th>Black</th>
                <th></th>
              </tr>
            </thead>
            <tbody>
              <% round.matches.each do |match| %>
              <tr>
                <td><span class="pull-right"><%= match.white_player.name %></span></td>
                <td><span class="pull-right"><%= match.white_result %></span></td>
                <td><%= match.black_result %></td>
                <td><%= match.black_player.name %></td>
                <td><%= link_to "View", tournament_round_match_path(@tournament, round, match) %></td>
              </tr>
              <% end %>
            </tbody>
          </table>
          </div>
        </div>
      </div>
    <% end %>
    </div>
  <% else %>
  <div class="alert alert-info"><p>This tournament has no rounds defined, yet.</p></div>
  <% end %>
  <% if can? :manage, @tournament %>
    <%= simple_form_for [@tournament, Round.new() ] do |f| %>
    <%= f.hidden_field :tournament_round_id, :value => Round.new(:tournament_id => @tournament.id).new_round_id %>
    <%= submit_tag "Create new round", :class => "btn btn-primary" %></p>
    <% end %>
  <% end %>

  </div>
</div>

<div class="form-actions">
  <%= link_to 'Edit', edit_tournament_path(@tournament), :class => "btn" %>
  <%= link_to 'Back', tournaments_path, :class => "btn" %>
</div>

